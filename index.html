<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plattform-Vorschau</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            updateProfile,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Backend-API URL
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:3001' : 
            `${window.location.protocol}//${window.location.hostname}:3001`;

        // Firebase mit Fallback-Mechanismus laden
        const initializeFirebase = async () => {
            console.log('üîÑ Initialisiere Firebase-Verbindung...');
            
            try {
                // Versuche Backend-Verbindung mit kurzem Timeout
                console.log('üì° Versuche Backend-Verbindung...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // Reduziert auf 3s
                
                const response = await fetch(`${API_BASE_URL}/api/config/firebase`, {
                    signal: controller.signal,
                    headers: {
                        'User-Agent': 'MusikPlattform-Frontend/1.0'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Server-Fehler: ${response.status}`);
                }
                
                const firebaseConfig = await response.json();
                console.log('‚úÖ Firebase-Konfiguration vom Backend erhalten');
                
                await initializeFirebaseWithConfig(firebaseConfig, true);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Backend nicht verf√ºgbar, verwende Fallback-Konfiguration:', error.message);
                
                // Fallback: Verwende lokale Firebase-Konfiguration
                const fallbackConfig = {
                    apiKey: "AIzaSyDdgu05VJewoLG9-Ad1jdU8ogee2C4_tKs",
                    authDomain: "meine-musikplattform.firebaseapp.com",
                    projectId: "meine-musikplattform",
                    storageBucket: "meine-musikplattform.appspot.com",
                    messagingSenderId: "997469107237",
                    appId: "1:997469107237:web:109d6cfa8829f01e547bcc",
                    measurementId: "G-7M62EV7KQH"
                };
                
                await initializeFirebaseWithConfig(fallbackConfig, false);
            }
        };

        // Firebase-Initialisierung mit Konfiguration
        const initializeFirebaseWithConfig = async (firebaseConfig, hasBackend) => {
            try {
                // Firebase App initialisieren
                let app;
                try {
                    app = initializeApp(firebaseConfig);
                    console.log(`‚úÖ Firebase erfolgreich initialisiert (${hasBackend ? 'mit Backend' : 'Standalone-Modus'})`);
                } catch (e) {
                    console.error("‚ùå Firebase initialization error:", e);
                    
                    // Auch bei Firebase-Fehler die App laden (Demo-Modus)
                    console.log('üé≠ Starte im Demo-Modus ohne Firebase');
                    initializeDemoMode();
                    return;
                }
                
                const auth = getAuth(app);
                
                // Global verf√ºgbar machen
                window.firebase = {
                    auth,
                    onAuthStateChanged,
                    createUserWithEmailAndPassword,
                    signInWithEmailAndPassword,
                    signOut,
                    sendPasswordResetEmail,
                    updateProfile,
                    updatePassword
                };

                // Backend-API-Konfiguration
                window.apiConfig = {
                    baseUrl: hasBackend ? API_BASE_URL : null,
                    hasBackend: hasBackend
                };
                
                console.log(`üöÄ Plattform bereit (${hasBackend ? 'Vollversion' : 'Demo-Modus'})`);
                
            } catch (error) {
                console.error("‚ùå Kritischer Initialisierungsfehler:", error);
                initializeDemoMode();
            }
        };

        // Demo-Modus f√ºr komplette Offline-Nutzung
        const initializeDemoMode = () => {
            console.log('üé≠ Demo-Modus aktiviert - alle Features verf√ºgbar (ohne persistente Speicherung)');
            
            // Mock Firebase Auth f√ºr Demo
            window.firebase = {
                auth: { currentUser: null },
                onAuthStateChanged: (auth, callback) => {
                    // Simuliere anonymen Benutzer nach kurzer Verz√∂gerung
                    setTimeout(() => {
                        const demoUser = {
                            uid: 'demo-user-123',
                            email: 'demo@example.com',
                            displayName: 'Demo Benutzer',
                            photoURL: null
                        };
                        callback(demoUser);
                    }, 1000);
                    return () => {}; // Unsubscribe function
                },
                createUserWithEmailAndPassword: async () => {
                    throw new Error('Registrierung im Demo-Modus nicht verf√ºgbar');
                },
                signInWithEmailAndPassword: async (auth, email, password) => {
                    // Demo-Login erlauben
                    if (email && password) {
                        return {
                            user: {
                                uid: 'demo-user-123',
                                email: email,
                                displayName: 'Demo Benutzer',
                                photoURL: null
                            }
                        };
                    }
                    throw new Error('Demo-Login: Bitte E-Mail und Passwort eingeben');
                },
                signOut: async () => {
                    console.log('Demo-Logout durchgef√ºhrt');
                },
                sendPasswordResetEmail: async () => {
                    throw new Error('Password-Reset im Demo-Modus nicht verf√ºgbar');
                },
                updateProfile: async () => {
                    console.log('Profil-Update im Demo-Modus simuliert');
                },
                updatePassword: async () => {
                    throw new Error('Passwort-√Ñnderung im Demo-Modus nicht verf√ºgbar');
                }
            };

            // Mock API-Konfiguration
            window.apiConfig = {
                baseUrl: null,
                hasBackend: false,
                demoMode: true
            };

            console.log('‚úÖ Demo-Modus erfolgreich konfiguriert');
        };

        // Initialisiere Firebase nach dem Laden der Seite
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFirebase);
        } else {
            initializeFirebase();
        }
    </script>
    
    <!-- Multi-Character-Sanitization Security Library -->
    <script src="multi-character-sanitizer.js"></script>
    
    <style>
        body { 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            background: #0f172a; /* Fallback background */
        }
        .text-shadow {
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .glass-pane {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
    </style>
</head>
<body class="text-white">
    <div id="root"></div>

    <script type="text/babel">
        // React Hooks und Context
        const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

        // --- Error Boundary f√ºr kritische Fehler ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('üö® Critical React Error:', error, errorInfo);
                
                // Emergency redirect nach 5 Sekunden
                setTimeout(() => {
                    if (confirm('Die Anwendung ist abgest√ºrzt. Zur Notfall-Version wechseln?')) {
                        window.location.href = 'emergency.html';
                    }
                }, 5000);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 p-4">
                            <div className="glass-pane p-8 rounded-2xl text-center max-w-md">
                                <div className="text-red-400 mb-4">
                                    <svg className="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-white mb-4">Anwendungsfehler</h2>
                                <p className="text-gray-300 mb-6">
                                    Die Anwendung ist unerwartet abgest√ºrzt. 
                                    Sie werden automatisch zur Notfall-Version weitergeleitet.
                                </p>
                                <div className="space-y-2">
                                    <button 
                                        onClick={() => window.location.href = 'demo.html'}
                                        className="w-full bg-blue-500 text-white py-2 px-4 rounded-lg font-bold mb-2"
                                    >
                                        Demo-Version √∂ffnen
                                    </button>
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-bold"
                                    >
                                        Seite neu laden
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // --- Auth Context f√ºr die Benutzerauthentifizierung ---
        const AuthContext = createContext(null);

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                let mounted = true;
                let unsubscribeAuth = null;
                
                const initializeAuth = async () => {
                    try {
                        // Warte maximal 15 Sekunden auf Firebase
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Firebase initialization timeout')), 15000);
                        });
                        
                        const firebasePromise = new Promise((resolve) => {
                            const checkFirebase = () => {
                                if (window.firebase && window.firebase.auth) {
                                    console.log('‚úÖ Firebase Auth verf√ºgbar');
                                    resolve(window.firebase);
                                } else {
                                    // Pr√ºfe alle 100ms f√ºr max 15 Sekunden
                                    setTimeout(checkFirebase, 100);
                                }
                            };
                            checkFirebase();
                        });
                        
                        // Race zwischen Firebase-Init und Timeout
                        const firebase = await Promise.race([firebasePromise, timeoutPromise]);
                        
                        if (!mounted) return;
                        
                        // Firebase Auth State Listener
                        unsubscribeAuth = firebase.onAuthStateChanged(firebase.auth, (user) => {
                            if (mounted) {
                                console.log('üîê Auth State Changed:', user ? 'Logged in' : 'Logged out');
                                setUser(user);
                                setLoading(false);
                                setError(null);
                            }
                        });
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Auth initialization failed:', error.message);
                        if (mounted) {
                            setError(error.message);
                            setLoading(false);
                            // Fortfahren ohne Auth - App soll trotzdem laden
                        }
                    }
                };
                
                // Starte Auth-Initialisierung
                initializeAuth();
                
                // Fallback: Lade App nach 20 Sekunden auf jeden Fall
                const fallbackTimeout = setTimeout(() => {
                    if (mounted && loading) {
                        console.warn('üö® Auth loading timeout - continuing without auth');
                        setLoading(false);
                        setError('Authentication timeout - continuing in demo mode');
                    }
                }, 20000);
                
                return () => {
                    mounted = false;
                    clearTimeout(fallbackTimeout);
                    if (unsubscribeAuth && typeof unsubscribeAuth === 'function') {
                        unsubscribeAuth();
                    }
                };
            }, []); // Leeres Dependency-Array verhindert Endlos-Schleifen

            const value = { user, setUser, error };

            // Zeige Loading nur f√ºr maximal 20 Sekunden
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900">
                        <div className="glass-pane p-8 rounded-2xl text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                            <p className="text-white text-lg font-semibold">Plattform wird geladen...</p>
                            <p className="text-gray-300 text-sm mt-2">
                                {error ? 'Demo-Modus wird vorbereitet...' : 'Verbindung wird hergestellt...'}
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <AuthContext.Provider value={value}>
                    {children}
                </AuthContext.Provider>
            );
        };

        const useAuth = () => {
            return useContext(AuthContext);
        };
        
        // --- Sichere HTML-Input-Sanitization mit Multi-Character-Schutz ---
        const safeHtmlInputHandler = (event) => {
            const target = event.target;
            const rawValue = target.value;
            
            // Multi-Character-sichere Sanitization verwenden
            if (window.multiCharacterSanitizer) {
                try {
                    const sanitizedValue = window.multiCharacterSanitizer.sanitize(rawValue, {
                        maxLength: target.maxLength || 10000,
                        allowHtml: target.dataset.allowHtml === 'true'
                    });
                    
                    // Nur bei √Ñnderungen aktualisieren (verhindert Cursor-Jumping)
                    if (sanitizedValue !== rawValue) {
                        const selectionStart = target.selectionStart;
                        const selectionEnd = target.selectionEnd;
                        
                        target.value = sanitizedValue;
                        
                        // Cursor-Position wiederherstellen
                        const lengthDiff = rawValue.length - sanitizedValue.length;
                        target.setSelectionRange(
                            Math.max(0, selectionStart - lengthDiff),
                            Math.max(0, selectionEnd - lengthDiff)
                        );
                        
                        // Warnung bei blockiertem Inhalt
                        if (lengthDiff > 0) {
                            console.warn('üîí Potentiell gef√§hrlicher Inhalt wurde entfernt');
                            
                            // Visual feedback f√ºr User
                            target.style.borderColor = '#f59e0b';
                            setTimeout(() => {
                                target.style.borderColor = '';
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Sanitization error:', error);
                    // Fallback: Entferne nur die gef√§hrlichsten Zeichen
                    target.value = rawValue.replace(/[<>'"]/g, '');
                }
            } else {
                // Fallback ohne Multi-Character-Library
                console.warn('Multi-Character-Sanitizer nicht verf√ºgbar, verwende Basic-Sanitization');
                target.value = rawValue
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }
        };

        // Data-Loss-Prevention mit Multi-Character-sicherer Sanitization  
        const preventDataLeakage = () => {
            // √úberwache Copy-Paste-Operationen bei sensiblen Feldern
            document.addEventListener('paste', (event) => {
                const target = event.target;
                if (target.type === 'password' || target.dataset.sensitive === 'true') {
                    const clipboardData = event.clipboardData.getData('text');
                    
                    // Multi-Character-sichere Sanitization
                    const sanitizedData = window.multiCharacterSanitizer ? 
                        window.multiCharacterSanitizer.sanitize(clipboardData, { maxLength: 1000 }) : 
                        clipboardData;
                    
                    // Pr√ºfe auf verd√§chtige Inhalte mit sicheren Patterns
                    const suspiciousPatterns = [
                        /password[\s\u00A0]{0,10}[:=][\s\u00A0]{0,10}[\w]{1,50}/i,
                        /token[\s\u00A0]{0,10}[:=][\s\u00A0]{0,10}[\w]{1,50}/i,
                        /api[_-]?key[\s\u00A0]{0,10}[:=][\s\u00A0]{0,10}[\w]{1,50}/i,
                        /secret[\s\u00A0]{0,10}[:=][\s\u00A0]{0,10}[\w]{1,50}/i,
                        /private[\s\u00A0]{0,10}[:=][\s\u00A0]{0,10}[\w]{1,50}/i
                    ];
                    
                    // Multi-Character-Bypass-sichere Pr√ºfung
                    const isSuspicious = suspiciousPatterns.some(pattern => {
                        try {
                            // Timeout-gesch√ºtzte Pattern-Pr√ºfung
                            const startTime = performance.now();
                            const result = pattern.test(sanitizedData);
                            const duration = performance.now() - startTime;
                            
                            if (duration > 50) { // 50ms Timeout
                                console.warn('Slow pattern detected, blocking for safety');
                                return true; // Bei langsamen Patterns blockieren
                            }
                            
                            return result;
                        } catch (error) {
                            console.error('Pattern test error:', error);
                            return true; // Bei Fehlern sicherheitshalber blockieren
                        }
                    });
                    
                    if (isSuspicious) {
                        event.preventDefault();
                        console.warn('üö® Suspicious data paste blocked (Multi-Character-protected)');
                        alert('Aus Sicherheitsgr√ºnden wurde das Einf√ºgen blockiert.');
                    }
                }
            });
            
            // Input-Event-Listener f√ºr alle Text-Inputs
            document.addEventListener('input', safeHtmlInputHandler);
            
            // Form-Submit-Sanitization
            document.addEventListener('submit', (event) => {
                const form = event.target;
                if (form.tagName === 'FORM') {
                    const inputs = form.querySelectorAll('input[type="text"], input[type="email"], textarea');
                    
                    inputs.forEach(input => {
                        if (window.multiCharacterSanitizer) {
                            try {
                                input.value = window.multiCharacterSanitizer.sanitize(input.value, {
                                    maxLength: input.maxLength || 10000,
                                    allowHtml: input.dataset.allowHtml === 'true'
                                });
                            } catch (error) {
                                console.error('Form sanitization error:', error);
                                // Fallback
                                input.value = input.value.replace(/[<>'"]/g, '');
                            }
                        }
                    });
                }
            });
        };

        // Sichere Formular-Validierung mit Multi-Character-Sanitization
        const validateForm = (formData, rules) => {
            const errors = {};
            const maxProcessingTime = 50; // 50ms max per regex
            
            Object.keys(rules).forEach(field => {
                const value = formData[field];
                const rule = rules[field];
                
                // Required-Validierung
                if (rule.required && (!value || value.trim() === '')) {
                    errors[field] = `${field} ist erforderlich`;
                    return;
                }
                
                if (value) {
                    // Multi-Pass-Sanitization f√ºr komplette Sicherheit
                    let sanitizedValue = value;
                    
                    if (window.multiCharacterSanitizer) {
                        try {
                            sanitizedValue = window.multiCharacterSanitizer.sanitize(value, {
                                maxLength: rule.maxLength || 10000,
                                allowHtml: false
                            });
                        } catch (error) {
                            console.error('Validation sanitization error:', error);
                            sanitizedValue = value.replace(/[<>'"]/g, ''); // Fallback
                        }
                    }
                    
                    // L√§ngenbegrenzung NACH Sanitization (verhindert Bypass durch Expansion)
                    if (sanitizedValue.length > 10000) {
                        errors[field] = `${field} ist zu lang f√ºr die Verarbeitung`;
                        return;
                    }
                    
                    // L√§ngen-Validierung mit sanitized value
                    if (rule.maxLength && sanitizedValue.length > rule.maxLength) {
                        errors[field] = `${field} ist zu lang (max. ${rule.maxLength} Zeichen)`;
                        return;
                    }
                    
                    if (rule.minLength && sanitizedValue.length < rule.minLength) {
                        errors[field] = `${field} ist zu kurz (min. ${rule.minLength} Zeichen)`;
                        return;
                    }
                    
                    // E-Mail-Validierung (Multi-Character-sicher)
                    if (rule.type === 'email') {
                        try {
                            const validatedEmail = window.multiCharacterSanitizer ? 
                                window.multiCharacterSanitizer.validateEmail(sanitizedValue) : 
                                sanitizedValue;
                            
                            // Zus√§tzliche L√§ngenbegrenzung
                            if (validatedEmail.length > 254) {
                                errors[field] = 'E-Mail-Adresse ist zu lang';
                                return;
                            }
                        } catch (error) {
                            errors[field] = error.message || 'Ung√ºltige E-Mail-Adresse';
                            return;
                        }
                    }
                    
                    // URL-Validierung (Multi-Character-sicher mit vollst√§ndiger Schema-Pr√ºfung)
                    if (rule.type === 'url') {
                        try {
                            // Verwende die erweiterte sichere URL-Validierung
                            const validatedUrl = window.multiCharacterSanitizer ? 
                                window.multiCharacterSanitizer.validateUrl(sanitizedValue, {
                                    allowRelative: rule.allowRelative !== false,
                                    requireHttps: rule.requireHttps === true,
                                    maxLength: rule.maxLength || 2048,
                                    allowedDomains: rule.allowedDomains,
                                    blockedDomains: rule.blockedDomains
                                }) : 
                                (() => {
                                    // Fallback mit Basic-URL-Validierung
                                    const urlObj = new URL(sanitizedValue);
                                    
                                    // Basis-Schema-Pr√ºfung als Fallback
                                    const allowedSchemes = ['http:', 'https:', 'ftp:', 'ftps:', 'mailto:', 'tel:', 'sms:'];
                                    if (!allowedSchemes.includes(urlObj.protocol)) {
                                        throw new Error(`URL-Schema '${urlObj.protocol}' ist nicht erlaubt`);
                                    }
                                    
                                    return urlObj.toString();
                                })();
                            
                            // Zus√§tzliche L√§ngenbegrenzung nach Validierung
                            if (typeof validatedUrl === 'string' && validatedUrl.length > (rule.maxLength || 2048)) {
                                errors[field] = `URL ist zu lang (max. ${rule.maxLength || 2048} Zeichen)`;
                                return;
                            }
                            
                        } catch (error) {
                            errors[field] = error.message || 'Ung√ºltige URL oder unsicheres Schema';
                            return;
                        }
                    }
                    
                    // Pattern-Validierung mit Multi-Character-Timeout-Schutz
                    if (rule.pattern) {
                        const startTime = performance.now();
                        try {
                            // Pre-sanitization f√ºr Pattern-Tests
                            const testValue = sanitizedValue.substring(0, 500); // L√§nge begrenzen
                            
                            const matches = rule.pattern.test(testValue);
                            const duration = performance.now() - startTime;
                            
                            if (duration > maxProcessingTime) {
                                console.warn(`Slow regex detected: ${rule.pattern} took ${duration}ms`);
                                errors[field] = 'Validierung zu langsam - bitte Eingabe √ºberpr√ºfen';
                                return;
                            }
                            
                            if (!matches) {
                                errors[field] = rule.message || `${field} hat ein ung√ºltiges Format`;
                            }
                        } catch (error) {
                            console.error('Regex error:', error);
                            errors[field] = 'Validierungsfehler - bitte Eingabe √ºberpr√ºfen';
                        }
                    }
                }
            });
            
            return {
                isValid: Object.keys(errors).length === 0,
                errors
            };
        };
        
        // --- Dynamic Background Component ---
        const DynamicGradientBackground = ({ children }) => {
            const [overlayOpacity, setOverlayOpacity] = useState(0);

            const updateOpacity = () => {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const currentTime = hours + minutes / 60;

                let opacity;

                // Helper function for smooth transition (linear interpolation)
                const interpolate = (startHour, endHour, startOpacity, endOpacity) => {
                    const duration = endHour - startHour;
                    const progress = (currentTime - startHour) / duration;
                    return startOpacity + progress * (endOpacity - startOpacity);
                };

                if (currentTime >= 21 || currentTime < 4) { // Night
                    opacity = 0.6;
                } else if (currentTime >= 4 && currentTime < 6) { // Transition to Dawn
                    opacity = interpolate(4, 6, 0.6, 0.1);
                } else if (currentTime >= 6 && currentTime < 8) { // Dawn
                    opacity = 0.1;
                } else if (currentTime >= 8 && currentTime < 10) { // Transition to Day
                    opacity = interpolate(8, 10, 0.1, 0.0);
                } else if (currentTime >= 10 && currentTime < 16) { // Day
                    opacity = 0.0;
                } else if (currentTime >= 16 && currentTime < 18) { // Transition to Dusk
                    opacity = interpolate(16, 18, 0.0, 0.4);
                } else if (currentTime >= 18 && currentTime < 20) { // Dusk
                    opacity = 0.4;
                } else if (currentTime >= 20 && currentTime < 21) { // Transition to Night
                    opacity = interpolate(20, 21, 0.4, 0.6);
                } else {
                    opacity = 0.0; // Fallback for day
                }
                
                setOverlayOpacity(opacity);
            };

            useEffect(() => {
                updateOpacity(); // Run once immediately
                const intervalId = setInterval(updateOpacity, 60000); // Check every 60 seconds

                return () => clearInterval(intervalId); // Cleanup on unmount
            }, []);

            return (
                <div className="relative min-h-screen w-full bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900">
                    <div 
                        className="absolute inset-0 bg-black transition-opacity duration-1000"
                        style={{ opacity: overlayOpacity }}
                    ></div>
                    <div className="relative z-10">
                        {children}
                    </div>
                </div>
            );
        };

        // --- MOCK DATA & ASSETS ---
        const platformLogos = { 'Instagram': 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png', 'Spotify': 'https://upload.wikimedia.org/wikipedia/commons/2/26/Spotify_logo_with_text.svg', 'Google Analytics 4': 'https://www.gstatic.com/analytics-suite/header/suite/v2/ic_analytics.svg', 'TikTok Organic': 'https://sf-static.tiktokcdn.com/obj/eden-sg/uhtyvueh7nulogpoguhm/tiktok-icon2.png', 'Facebook Ads': 'https://upload.wikimedia.org/wikipedia/commons/6/6c/Facebook_Ads_logo.svg', 'Stripe': 'https://upload.wikimedia.org/wikipedia/commons/b/ba/Stripe_Logo%2C_revised_2016.svg' };
        const kpiLabels = { total_followers: 'Follower insgesamt', reel_views: 'Reel Aufrufe', total_users: 'Nutzer insgesamt', engagement_rate: 'Engagement-Rate' };
        const availablePlatforms = [ { id: 'google_analytics_4', name: 'Google Analytics 4' }, { id: 'instagram', name: 'Instagram' }, { id: 'tiktok_organic', name: 'TikTok Organic' }, { id: 'facebook_ads', name: 'Facebook Ads' }, { id: 'stripe', name: 'Stripe' } ];
        const mockIntegrations = { 'int_ga4_123': { id: 'int_ga4_123', platform: 'Google Analytics 4', accountName: 'Mein Online-Shop', status: 'connected' }, 'int_ig_456': { id: 'int_ig_456', platform: 'Instagram', accountName: '@neondreams_band', status: 'connected' }, 'int_tiktok_789': { id: 'int_tiktok_789', platform: 'TikTok Organic', accountName: 'neondreams_official', status: 'pending' } };
        const mockDashboards = [ { id: 'dash_1', name: 'Album Release "Neon Dreams" - Performance', logoUrl: 'https://placehold.co/100x40/1a1a1a/ffffff?text=ND', widgets: [ { id: 'w1', integrationId: 'int_ig_456', kpi: 'total_followers', timeFrame: 'last_30_days', w: 4, h: 2 }, { id: 'w2', integrationId: 'int_ig_456', kpi: 'reel_views', timeFrame: 'last_7_days', w: 4, h: 2 }, { id: 'w3', integrationId: 'int_ga4_123', kpi: 'total_users', timeFrame: 'last_30_days', w: 4, h: 2 }, { id: 'w4', integrationId: 'int_ga4_123', kpi: 'engagement_rate', timeFrame: 'last_30_days', w: 8, h: 2 } ] } ];
        const mockDashboardData = { keyKpis: [ { platform: 'Instagram', kpi: 'Follower insgesamt', value: '48.152', change: 1.2 }, { platform: 'Spotify', kpi: 'Monatliche H√∂rer', value: '1.2M', change: 5.3 }, { platform: 'Google Analytics 4', kpi: 'Nutzer (letzte 7 Tage)', value: '12.830', change: -2.1 } ], learningProgress: { pathTitle: 'Onboarding f√ºr neue K√ºnstler:innen', progress: 75 }};
        const initialProjects = [
            { id: 'proj_1', name: 'Album Release "Neon Dreams"', files: [], moodboards: [ { id: 'mood_1', title: 'Cover Artwork & Visuals', items: [ { id: 'item_1', type: 'image', content: 'https://placehold.co/600x400/1a1a1a/ffffff?text=Inspiration+1', x: 50, y: 50, w: 250, h: 180 }, { id: 'item_2', type: 'text', content: 'Key Words: Retro, 80s, Chrome, Sunset', x: 350, y: 80, w: 200, h: 100 }, { id: 'item_3', type: 'image', content: 'https://placehold.co/600x400/4a4a4a/ffffff?text=Inspiration+2', x: 80, y: 280, w: 300, h: 200 }, { id: 'item_4', type: 'video', content: 'Video-Referenz', x: 420, y: 250, w: 220, h: 150 } ] } ], taskboards: [ { id: 'task_1', title: 'Marketing & PR Plan', sections: [ { id: 'sec_1', title: 'To Do', tasks: [ { id: 't_1', title: 'Pressemitteilung entwerfen', priority: 'high', assignee: 'Anna', dueDate: '2025-08-15', completed: false }, { id: 't_2', title: 'Social Media Grafiken erstellen', priority: 'medium', assignee: 'Max', dueDate: '2025-08-20', completed: false } ] }, { id: 'sec_2', title: 'In Progress', tasks: [ { id: 't_3', title: 'Interview-Partner anfragen', priority: 'high', assignee: 'Anna', completed: false } ] }, { id: 'sec_3', title: 'Done', tasks: [ { id: 't_4', title: 'Marketing-Budget finalisieren', priority: 'medium', assignee: 'Chris', dueDate: '2025-07-20', completed: true } ] } ] } ] }
        ];
        const mockCmsData = { data: [ { id: 1, title: "Band√ºbernahmevertrag (Standard)", description: "Ein Standardvertrag zur √úbertragung der Master-Rechte.", category: "Vertr√§ge", files: { docx: "#", pdf: "#" }, tags: ["Recording", "Rechte", "Label"] }, { id: 2, title: "Booking-Anfrage (Vorlage)", description: "Vorlage f√ºr Anfragen an Veranstalter.", category: "Booking", files: { docx: "#" }, tags: ["Live", "Konzert"] }, { id: 3, title: "Pressekit-Checkliste", description: "Alle wichtigen Inhalte f√ºr ein Pressekit.", category: "Best Practices", files: { pdf: "#", notion: "#" }, tags: ["PR", "Marketing", "EPK"] } ] };
        const mockKnowledgeBase = { data: [ { id: 'kb-1', title: "Wie richte ich mein E-Mail-Konto ein?", category: "Setup", tags: ["email", "mdm"] }, { id: 'kb-2', title: "Was ist ein AV-Vertrag?", category: "DSGVO", tags: ["datenschutz", "vertrag"] }, { id: 'kb-3', title: "Wie teile ich ein Moodboard?", category: "Kollaboration", tags: ["moodboard", "sharing"] } ] };
        const mockLearningPaths = [ { id: 'lp1', title: "Onboarding f√ºr neue K√ºnstler:innen", description: "Alle Grundlagen f√ºr einen erfolgreichen Start.", targetRole: "K√ºnstler", modules: [ { id: 'm1-1', title: "Willkommen im Team!", type: 'video' }, { id: 'm1-2', title: "Unsere Kommunikations-Tools", type: 'text', content: 'Wir nutzen Slack f√ºr die t√§gliche Kommunikation und Asana f√ºr das Projektmanagement...' }, { id: 'm1-3', title: "Grundlagen der GEMA-Meldung", type: 'text', content: 'Jeder Live-Auftritt muss gemeldet werden...' }, { id: 'm1-4', title: "Wissens-Check: Kommunikation", type: 'quiz', content: { question: "Welches Tool nutzen wir f√ºr das Projektmanagement?", options: ["Slack", "Asana", "Trello"], correctAnswerIndex: 1 }} ] }, { id: 'lp2', title: "Einf√ºhrung f√ºr Freelance-Booker", description: "So arbeitest du effektiv mit uns.", targetRole: "Freelancer", modules: [ { id: 'm2-1', title: "√úbersicht unserer K√ºnstler-Roster", type: 'text' }, { id: 'm2-2', title: "Der Booking-Prozess", type: 'video' }, { id: 'm2-3', title: "Wissens-Check: Vertr√§ge", type: 'quiz', content: { question: "Wo findest du die Vertragsvorlagen?", options: ["Google Drive", "SmartLibrary"], correctAnswerIndex: 1 }} ] } ];
        const dsgvoQuestions = [ { id: 'q1', text: "F√ºhrst du ein Verzeichnis von Verarbeitungst√§tigkeiten (VVT)?" }, { id: 'q2', text: "Hast du eine Datenschutzerkl√§rung auf deiner Webseite?" }, { id: 'q3', text: "Schlie√üt du Auftragsverarbeitungs-Vertr√§ge (AVV) mit Dienstleistern ab?" } ];
        const priorityColors = { low: 'bg-green-500', medium: 'bg-yellow-500', high: 'bg-red-500' };

        // --- ICON Component ---
        const Icon = ({ name, className }) => {
            const icons = {
                bell: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
                briefcase: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
                fileText: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
                checkCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 20 20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
                image: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
                award: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>,
                search: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
                plus: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
                zap: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
                barChart: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
                users: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
                paperclip: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>,
                calendar: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
                user: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
                share2: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>,
                video: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>,
                music: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>,
                type: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>,
                clock: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
                edit2: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
                trash2: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
                moreVertical: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>,
                link: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>,
                xCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>,
                messageSquare: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>,
                bookOpen: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>,
                send: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
                circle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle></svg>,
                playCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>,
                helpCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
                arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
                shieldCheck: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>,
                x: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                download: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
                logOut: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
                menu: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
                uploadCloud: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 10a6 6 0 0 0-12 0Z"/><path d="M12 10v10"/><path d="m8 14 4-4 4 4"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
            };
            return icons[name] || null;
        };

        // --- PAGE COMPONENTS ---
        const PageWrapper = ({ children }) => (
            <div className="p-4 sm:p-6 lg:p-8 font-sans">
                <div className="max-w-7xl mx-auto">
                    {children}
                </div>
            </div>
        );
        
        // --- LandingPage Component ---
        const LandingPage = ({ setActiveAuthPage }) => {
            const features = [
                {
                    icon: "barChart",
                    title: "Zentrales Analytics-Dashboard",
                    description: "Verbinde all deine Plattformen und behalte den √úberblick √ºber deine wichtigsten Kennzahlen an einem Ort."
                },
                {
                    icon: "users",
                    title: "Kollaborative Projekte",
                    description: "Plane Kampagnen mit Moodboards, Aufgaben und geteilten Dateien. Lade Dritte zur Ansicht oder Bearbeitung ein."
                },
                {
                    icon: "zap",
                    title: "KI-gest√ºtzter Assistent",
                    description: "Erhalte sofortige Antworten und Strategien zu Musikmarketing, Ver√∂ffentlichungen und mehr von deinem pers√∂nlichen Experten."
                },
                {
                    icon: "bookOpen",
                    title: "Smart Library",
                    description: "Greife auf eine kuratierte Sammlung von Vorlagen, Vertr√§gen und Best Practices f√ºr das Musikbusiness zu."
                },
                {
                    icon: "award",
                    title: "Learning Center",
                    description: "Erweitere dein Wissen mit gef√ºhrten Lernpfaden, die speziell f√ºr K√ºnstler und ihre Teams entwickelt wurden."
                },
                {
                    icon: "uploadCloud",
                    title: "Dateien & Freigaben",
                    description: "Verwalte all deine Projektdateien zentral und teile sie sicher mit externen Partnern √ºber Links."
                }
            ];

            return (
                <div className="text-gray-100">
                    {/* Header */}
                    <header className="sticky top-0 glass-pane z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-6" style={{ minHeight: '150px' }}>
                                <img src="https://github.com/mmmaaalllttteee/meine-musik-plattform/blob/main/wmitw_web.png?raw=true" alt="Logo" className="h-[150px] w-[150px] object-contain" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/150x150/ffffff/000000?text=Logo'; }} />
                                <button onClick={() => setActiveAuthPage('login')} className="glass-pane px-4 py-2 rounded-lg text-sm font-bold text-shadow hover:bg-white/20 transition">Login</button>
                            </div>
                        </div>
                    </header>

                    {/* Hero Section */}
                    <main>
                        <div className="relative">
                            <div className="max-w-7xl mx-auto sm:px-6 lg:px-8 py-24 sm:py-32">
                                <div className="relative px-4 py-16 sm:px-6 sm:py-24 lg:py-32 lg:px-8 text-center">
                                    <h1 className="text-4xl font-extrabold tracking-tight sm:text-5xl lg:text-6xl text-shadow">
                                        <span className="block text-white">Dein Betriebssystem</span>
                                        <span className="block text-indigo-200">f√ºr das Musikbusiness</span>
                                    </h1>
                                    <p className="mt-6 max-w-lg mx-auto text-xl text-indigo-100 sm:max-w-3xl text-shadow">
                                        Von Analytics √ºber Projektmanagement bis hin zu KI-gest√ºtzter Beratung ‚Äì alles, was du f√ºr deinen Erfolg brauchst.
                                    </p>
                                    <div className="mt-10 max-w-sm mx-auto sm:max-w-none sm:flex sm:justify-center">
                                        <button onClick={() => setActiveAuthPage('register')} className="bg-white/90 text-blue-900 font-bold text-lg px-8 py-3 rounded-lg shadow-lg hover:bg-white transition">
                                            Jetzt kostenlos starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Features Section */}
                        <div className="py-16 sm:py-20">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="text-center">
                                    <h2 className="text-3xl font-extrabold tracking-tight text-shadow">Alles an einem Ort</h2>
                                    <p className="mt-4 max-w-2xl mx-auto text-xl text-gray-300 text-shadow">
                                        Konzentriere dich auf deine Musik, wir k√ºmmern uns um den Rest.
                                    </p>
                                </div>
                                <div className="mt-12 grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                                    {features.map((feature) => (
                                        <div key={feature.title} className="glass-pane p-6 rounded-2xl shadow-lg">
                                            <div className="flex-shrink-0">
                                                <Icon name={feature.icon} className="h-8 w-8 text-indigo-300" />
                                            </div>
                                            <h3 className="mt-4 text-lg font-bold text-shadow">{feature.title}</h3>
                                            <p className="mt-2 text-base text-gray-300 text-shadow">{feature.description}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="">
                        <div className="max-w-7xl mx-auto py-12 px-4 sm:px-6 md:flex md:items-center md:justify-between lg:px-8">
                            <div className="mt-8 md:mt-0 md:order-1">
                                <p className="text-center text-base text-gray-400">&copy; {new Date().getFullYear()} We make IT work. Alle Rechte vorbehalten.</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };
        
        // --- MainDashboard Component ---
        const MainDashboard = ({setActivePage, activities, complyCheckScore}) => {
            const { user } = useAuth();
            const data = mockDashboardData;
            const [searchTerm, setSearchTerm] = useState("");
            const [searchResults, setSearchResults] = useState([]);

            const handleSearch = (e) => {
                const term = e.target.value;
                setSearchTerm(term);
                if (term.trim() === "") {
                    setSearchResults([]);
                    return;
                }
                const results = mockKnowledgeBase.data.filter(article => 
                    article.title.toLowerCase().includes(term.toLowerCase()) ||
                    article.category.toLowerCase().includes(term.toLowerCase())
                );
                setSearchResults(results);
            };

            const WelcomeHeader = ({ user }) => (
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                    <div className="mb-4 sm:mb-0">
                        <h1 className="text-2xl sm:text-3xl font-bold text-shadow">Willkommen zur√ºck, {user?.displayName || 'User'}!</h1>
                        <p className="text-gray-300 text-shadow">Hier ist dein √úberblick f√ºr heute.</p>
                    </div>
                    <div className="flex items-center gap-4">
                        <button className="relative text-gray-300 hover:text-white"><Icon name="bell" className="w-6 h-6" /><span className="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-gray-900"></span></button>
                        <img src={user?.photoURL || `https://placehold.co/100x100/EBF4FF/1a1a1a?text=${user?.displayName?.charAt(0) || 'U'}`} alt="User Avatar" className="w-10 h-10 rounded-full" />
                    </div>
                </div>
            );
            const KpiWidget = ({ kpi }) => (
                <div className="glass-pane p-4 rounded-2xl"><div className="flex items-center gap-3 mb-2"><img src={platformLogos[kpi.platform]} onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} alt={kpi.platform} className="h-5 object-contain rounded-md" /><span className="text-sm font-medium text-gray-300 text-shadow">{kpi.kpi}</span></div><p className="text-2xl font-bold text-shadow">{kpi.value}</p><p className={`text-sm font-semibold ${kpi.change >= 0 ? 'text-green-400' : 'text-red-400'}`}>{kpi.change >= 0 ? '‚ñ≤' : '‚ñº'} {kpi.change}%</p></div>
            );
            const RecentActivityWidget = ({ activities }) => (
                <div className="glass-pane p-6 rounded-2xl h-full"><h3 className="font-bold text-lg mb-4 text-shadow">Letzte Aktivit√§ten</h3><div className="space-y-4">{activities.map(act => (<div key={act.id} className="flex items-start gap-3"><div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center flex-shrink-0">{act.type === 'task_completed' ? <Icon name="checkCircle" className="w-5 h-5 text-green-400" /> : <Icon name="image" className="w-5 h-5 text-blue-400" />}</div><div><p className="text-sm font-medium text-gray-200 text-shadow">{act.text}</p><p className="text-xs text-gray-400">{act.project} ¬∑ {act.time}</p></div></div>))}</div></div>
            );
            const LearningProgressWidget = ({ learning }) => (
                <div className="glass-pane p-6 rounded-2xl"><div className="flex items-center gap-3 mb-3"><Icon name="award" className="w-6 h-6 text-yellow-400" /><h3 className="font-bold text-lg text-shadow">Dein Lernfortschritt</h3></div><p className="text-sm text-gray-300 text-shadow mb-2">{learning.pathTitle}</p><div className="w-full bg-white/20 rounded-full h-2.5"><div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${learning.progress}%` }}></div></div><a href="#" onClick={() => setActivePage('learningcenter')} className="text-sm font-semibold text-blue-400 mt-3 inline-block">Weiterlernen ‚Üí</a></div>
            );
            const QuickAccessWidget = ({ title, icon: IconName, pageId }) => (
                <a href="#" onClick={() => setActivePage(pageId)} className="glass-pane p-6 rounded-2xl flex flex-col items-center justify-center text-center hover:bg-white/20 transition-all"><Icon name={IconName} className="w-8 h-8 text-blue-300 mb-3" /><p className="font-semibold text-shadow">{title}</p></a>
            );
            return (
                <PageWrapper>
                    <WelcomeHeader user={user} />
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {data.keyKpis.map((kpi) => <div key={kpi.platform} className="lg:col-span-1"><KpiWidget kpi={kpi} /></div>)}
                        <div className="md:col-span-2 lg:col-span-2 grid grid-cols-2 gap-6"><QuickAccessWidget title="Projekte" icon="briefcase" pageId="projects" /><QuickAccessWidget title="Vorlagen" icon="fileText" pageId="library" /></div>
                        <div className="md:col-span-2 lg:col-span-2 row-span-2"><RecentActivityWidget activities={activities} /></div>
                        <div className="md:col-span-1 lg:col-span-1"><LearningProgressWidget learning={data.learningProgress} /></div>
                        <div className="md:col-span-1 lg:col-span-1 grid grid-cols-1 gap-6">
                            <div className="glass-pane p-6 rounded-2xl">
                                <h3 className="font-bold text-lg mb-3 text-shadow">Support Hub</h3>
                                <div className="relative">
                                    <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                                    <input type="text" placeholder="Wissen durchsuchen..." value={searchTerm} onChange={handleSearch} className="w-full pl-9 pr-3 py-2 text-sm border border-white/20 rounded-lg bg-white/10 text-white placeholder-gray-400" />
                                    {searchResults.length > 0 && (
                                        <div className="absolute top-full mt-2 w-full glass-pane border-none rounded-lg shadow-lg z-10">
                                            {searchResults.map(item => (
                                                <a href="#" onClick={() => setActivePage('support')} key={item.id} className="block p-3 hover:bg-white/10 text-sm">{item.title}</a>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="glass-pane p-6 rounded-2xl">
                                <h3 className="font-bold text-lg mb-3 text-shadow">ComplyCheck</h3>
                                <p className="text-sm text-gray-300">Letzter DSGVO-Check:</p>
                                <p className="font-bold text-lg text-shadow">{complyCheckScore}</p>
                            </div>
                        </div>
                    </div>
                </PageWrapper>
            );
        };
        
        // --- ProjectPage Components ---
        const ProjectListPage = ({ projects, setProjects, onSelectProject, onCreateProject }) => {
            const [newProjectName, setNewProjectName] = useState("");

            const handleCreate = () => {
                if (newProjectName.trim()) {
                    onCreateProject(newProjectName);
                    setNewProjectName("");
                }
            };

            return (
                <PageWrapper>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                        <h1 className="text-3xl sm:text-4xl font-bold text-shadow mb-4 sm:mb-0">Deine Projekte</h1>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={newProjectName} 
                                onChange={(e) => setNewProjectName(e.target.value)} 
                                placeholder="Neuer Projektname..." 
                                className="w-full sm:w-auto p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400"
                            />
                            <button onClick={handleCreate} className="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">Erstellen</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {projects.map(project => (
                            <div key={project.id} onClick={() => onSelectProject(project.id)} className="glass-pane p-6 rounded-2xl cursor-pointer hover:bg-white/20 transition">
                                <h2 className="text-xl font-bold text-shadow">{project.name}</h2>
                                <p className="text-sm text-gray-300 mt-2">{project.taskboards[0].sections.flatMap(s => s.tasks).length} Aufgaben</p>
                            </div>
                        ))}
                    </div>
                </PageWrapper>
            );
        };

        const ProjectDetailPage = ({ project, setProjectData, onBack, accessMode = 'edit' }) => {
            const [activeTab, setActiveTab] = useState('tasks');
            const [shareModalOpen, setShareModalOpen] = useState(false);
            
            const handleProjectUpdate = (updatedProject) => {
                setProjectData(updatedProject);
            };

            return (
                <PageWrapper>
                    {shareModalOpen && <ShareModal project={project} onClose={() => setShareModalOpen(false)} />}
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                        <div className="mb-4 sm:mb-0">
                            <button onClick={onBack} className="flex items-center gap-2 text-sm mb-2 text-gray-300 hover:text-white">
                                <Icon name="arrowLeft" className="w-4 h-4" /> Zur√ºck zu allen Projekten
                            </button>
                            <h1 className="text-3xl font-bold text-shadow">{project.name}</h1>
                            <p className="text-gray-300 mt-1 text-shadow">Projekt-Workspace</p>
                        </div>
                        <div className="relative">
                            <button onClick={() => setShareModalOpen(true)} className="glass-pane flex items-center px-4 py-2 rounded-lg shadow-sm"><Icon name="share2" className="w-4 h-4 mr-2" /> Teilen</button>
                        </div>
                    </header>
                    <div className="mb-6 border-b border-white/20"><nav className="-mb-px flex space-x-6"><button onClick={() => setActiveTab('moodboard')} className={`${activeTab === 'moodboard' ? 'border-blue-400 text-white' : 'border-transparent text-gray-300 hover:text-white'} py-4 px-1 border-b-2 font-medium text-sm`}>Moodboard</button><button onClick={() => setActiveTab('tasks')} className={`${activeTab === 'tasks' ? 'border-blue-400 text-white' : 'border-transparent text-gray-300 hover:text-white'} py-4 px-1 border-b-2 font-medium text-sm`}>Aufgaben</button><button onClick={() => setActiveTab('files')} className={`${activeTab === 'files' ? 'border-blue-400 text-white' : 'border-transparent text-gray-300 hover:text-white'} py-4 px-1 border-b-2 font-medium text-sm`}>Dateien</button></nav></div>
                    {activeTab === 'moodboard' && <Moodboard board={project.moodboards[0]} />}
                    {activeTab === 'tasks' && <Taskboard board={project.taskboards[0]} onTaskboardUpdate={(updatedTaskboard) => handleProjectUpdate({...project, taskboards: [updatedTaskboard]})} isEditable={accessMode === 'edit'} />}
                    {activeTab === 'files' && <FilesPage project={project} onProjectUpdate={handleProjectUpdate} isEditable={accessMode === 'edit'} />}
                </PageWrapper>
            );
        };
        
        const ShareModal = ({ project, onClose }) => {
            const [copied, setCopied] = useState('');
            const baseUrl = window.location.origin + window.location.pathname;
            const viewLink = `${baseUrl}?project=${project.id}&mode=view`;
            const editLink = `${baseUrl}?project=${project.id}&mode=edit`;

            const copyToClipboard = (text, type) => {
                navigator.clipboard.writeText(text).then(() => {
                    setCopied(type);
                    setTimeout(() => setCopied(''), 2000);
                }).catch(err => {
                    console.error('Fehler beim Kopieren in die Zwischenablage: ', err);
                    // Fallback f√ºr √§ltere Browser, falls n√∂tig
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setCopied(type);
                        setTimeout(() => setCopied(''), 2000);
                    } catch (err) {
                        console.error('Fallback: Kopieren fehlgeschlagen', err);
                    }
                    document.body.removeChild(textArea);
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="glass-pane rounded-2xl w-full max-w-lg text-white" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-white/20">
                            <h2 className="text-xl font-bold text-shadow">Projekt teilen: {project.name}</h2>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="font-semibold text-shadow">Link mit Leserechten</label>
                                <p className="text-xs text-gray-300 mb-2">Jeder mit diesem Link kann das Projekt ansehen.</p>
                                <div className="flex gap-2">
                                    <input type="text" readOnly value={viewLink} className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-gray-300 text-sm" />
                                    <button onClick={() => copyToClipboard(viewLink, 'view')} className="bg-blue-500 px-4 rounded-lg text-sm">{copied === 'view' ? 'Kopiert!' : 'Kopieren'}</button>
                                </div>
                            </div>
                             <div>
                                <label className="font-semibold text-shadow">Link mit Bearbeitungsrechten</label>
                                <p className="text-xs text-gray-300 mb-2">Jeder mit diesem Link kann Aufgaben im Projekt bearbeiten.</p>
                                <div className="flex gap-2">
                                    <input type="text" readOnly value={editLink} className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-gray-300 text-sm" />
                                    <button onClick={() => copyToClipboard(editLink, 'edit')} className="bg-blue-500 px-4 rounded-lg text-sm">{copied === 'edit' ? 'Kopiert!' : 'Kopieren'}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Moodboard = ({ board }) => {
            const [items, setItems] = useState(board?.items || []);
            const [selectedItem, setSelectedItem] = useState(null);
            const [isEditing, setIsEditing] = useState(false);

            const handleItemClick = (item) => {
                setSelectedItem(item);
            };

            const handleAddItem = (type) => {
                const newItem = {
                    id: `item_${Date.now()}`,
                    type: type,
                    content: type === 'text' ? 'Neuer Text' : 'https://placehold.co/300x200/333/fff?text=Neu',
                    x: Math.random() * 400,
                    y: Math.random() * 300,
                    w: type === 'text' ? 200 : 250,
                    h: type === 'text' ? 100 : 180
                };
                setItems(prev => [...prev, newItem]);
            };

            return (
                <div className="glass-pane p-6 rounded-2xl">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-shadow">{board?.title || 'Moodboard'}</h2>
                        <div className="flex gap-2">
                            <button onClick={() => handleAddItem('image')} className="bg-blue-500 text-white px-3 py-1 rounded text-sm">
                                <Icon name="image" className="w-4 h-4 inline mr-1" /> Bild
                            </button>
                            <button onClick={() => handleAddItem('text')} className="bg-green-500 text-white px-3 py-1 rounded text-sm">
                                <Icon name="type" className="w-4 h-4 inline mr-1" /> Text
                            </button>
                        </div>
                    </div>
                    
                    <div className="relative bg-white/5 rounded-lg min-h-[500px] overflow-hidden">
                        {items.map(item => (
                            <div
                                key={item.id}
                                className="absolute cursor-pointer hover:shadow-lg transition-shadow"
                                style={{
                                    left: `${item.x}px`,
                                    top: `${item.y}px`,
                                    width: `${item.w}px`,
                                    height: `${item.h}px`
                                }}
                                onClick={() => handleItemClick(item)}
                            >
                                {item.type === 'image' ? (
                                    <img
                                        src={item.content}
                                        alt="Moodboard Item"
                                        className="w-full h-full object-cover rounded border-2 border-white/20"
                                        onError={(e) => {
                                            e.target.src = 'https://placehold.co/300x200/333/fff?text=Bild+nicht+gefunden';
                                        }}
                                    />
                                ) : item.type === 'video' ? (
                                    <div className="w-full h-full bg-gray-800 rounded border-2 border-white/20 flex items-center justify-center">
                                        <Icon name="video" className="w-12 h-12 text-gray-400" />
                                        <span className="text-xs text-gray-300 mt-2">{item.content}</span>
                                    </div>
                                ) : (
                                    <div className="w-full h-full bg-yellow-500/20 rounded border-2 border-yellow-500/50 p-2 flex items-center justify-center">
                                        <p className="text-sm text-center text-shadow font-medium">{item.content}</p>
                                    </div>
                                )}
                            </div>
                        ))}
                        
                        {items.length === 0 && (
                            <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                                <div className="text-center">
                                    <Icon name="image" className="w-16 h-16 mx-auto mb-4 opacity-50" />
                                    <p>F√ºge Bilder und Texte hinzu, um dein Moodboard zu erstellen</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const Taskboard = ({ board, onTaskboardUpdate, isEditable }) => {
            const [currentBoard, setCurrentBoard] = useState(board);
            const [draggedTask, setDraggedTask] = useState(null);
            const [sourceSection, setSourceSection] = useState(null);
            const [newTaskTitle, setNewTaskTitle] = useState("");
            const [addingToSection, setAddingToSection] = useState(null);

            useEffect(() => {
                setCurrentBoard(board);
            }, [board]);

            const handleUpdate = (newBoard) => {
                setCurrentBoard(newBoard);
                onTaskboardUpdate(newBoard);
            };

            const handleDragStart = (e, task, sectionId) => { if (isEditable) { setDraggedTask(task); setSourceSection(sectionId); e.dataTransfer.effectAllowed = 'move'; }};
            const handleDragOver = (e) => { if (isEditable) e.preventDefault(); };
            const handleDrop = (e, targetSectionId) => {
                if (!isEditable || !draggedTask || sourceSection === targetSectionId) return;
                
                const newBoard = JSON.parse(JSON.stringify(currentBoard));
                const sourceSec = newBoard.sections.find(s => s.id === sourceSection);
                const taskIndex = sourceSec.tasks.findIndex(t => t.id === draggedTask.id);
                sourceSec.tasks.splice(taskIndex, 1);
                const targetSec = newBoard.sections.find(s => s.id === targetSectionId);
                targetSec.tasks.push(draggedTask);
                
                handleUpdate(newBoard);
                setDraggedTask(null);
                setSourceSection(null);
            };

            const handleAddTask = (sectionId) => {
                if (!isEditable || !newTaskTitle.trim()) return;
                
                const newTask = { id: `t_${Date.now()}`, title: newTaskTitle, priority: 'medium', assignee: null, dueDate: null, completed: false };
                const newBoard = JSON.parse(JSON.stringify(currentBoard));
                const section = newBoard.sections.find(s => s.id === sectionId);
                section.tasks.push(newTask);
                
                handleUpdate(newBoard);
                setNewTaskTitle("");
                setAddingToSection(null);
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {currentBoard.sections.map(section => (
                        <div key={section.id} className="bg-black/10 rounded-2xl p-4 flex flex-col min-h-[400px]" onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, section.id)}>
                            <h3 className="font-bold text-lg mb-4 text-shadow">{section.title} <span className="text-sm font-normal text-gray-300">{section.tasks.length}</span></h3>
                            <div className="flex-grow space-y-4">
                                {section.tasks.map(task => (
                                    <div key={task.id} draggable={isEditable} onDragStart={(e) => handleDragStart(e, task, section.id)} className={`glass-pane p-4 rounded-lg shadow-md ${isEditable ? 'cursor-grab active:cursor-grabbing' : ''}`}>
                                        <div className="flex justify-between items-start"><p className="font-semibold text-shadow">{task.title}</p><div className={`w-3 h-3 rounded-full ${priorityColors[task.priority]}`}></div></div>
                                        <div className="flex items-center text-xs text-gray-300 mt-3 space-x-4">
                                            {task.dueDate && <span className="flex items-center"><Icon name="calendar" className="w-3 h-3 mr-1" /> {task.dueDate}</span>}
                                            {task.assignee && <span className="flex items-center"><Icon name="user" className="w-3 h-3 mr-1" /> {task.assignee}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {isEditable && (addingToSection === section.id ? (
                                <div className="mt-4">
                                    <textarea value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" placeholder="Aufgabentitel..."></textarea>
                                    <div className="flex items-center gap-2 mt-2">
                                        <button onClick={() => handleAddTask(section.id)} className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Hinzuf√ºgen</button>
                                        <button onClick={() => setAddingToSection(null)}><Icon name="x" className="w-5 h-5" /></button>
                                    </div>
                                </div>
                            ) : (
                                <button onClick={() => setAddingToSection(section.id)} className="mt-4 w-full p-2 bg-blue-500 text-white rounded-lg text-sm font-bold">Neue Aufgabe hinzuf√ºgen</button>
                            ))}
                        </div>
                    ))}
                </div>
            );
        };
        
        const FilesPage = ({ project, onProjectUpdate, isEditable }) => {
            const [showAddLinkModal, setShowAddLinkModal] = useState(false);
            const [selectedFiles, setSelectedFiles] = useState([]);
            const fileInputRef = useRef(null);

            const compatibleFileTypes = [
                'audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/mp4',
                'image/jpeg', 'image/png', 'image/gif', 'image/svg+xml',
                'video/mp4', 'video/quicktime',
                'application/pdf', 'text/plain',
                'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'application/x-iwork-pages-sffpages',
                'application/x-iwork-numbers-sffnumbers',
                'application/x-iwork-keynote-sffkey'
            ].join(',');

            const getFileIcon = (type) => {
                if (type.startsWith('audio/')) return 'music';
                if (type.startsWith('image/')) return 'image';
                if (type.startsWith('video/')) return 'video';
                if (type === 'application/pdf') return 'fileText';
                if (type === 'link') return 'link';
                return 'file';
            };

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                const newFiles = files.map(file => ({
                    id: `file_${Date.now()}_${Math.random()}`,
                    name: file.name,
                    type: 'file',
                    fileType: file.type,
                    size: file.size,
                }));

                onProjectUpdate({ ...project, files: [...project.files, ...newFiles] });
            };

            const handleAddLink = (title, url) => {
                const newLink = {
                    id: `link_${Date.now()}`,
                    name: title,
                    type: 'link',
                    url: url,
                };
                onProjectUpdate({ ...project, files: [...project.files, newLink] });
                setShowAddLinkModal(false);
            };
            
            const handleShareSelected = () => {
                if (selectedFiles.length === 0) return;
                const shareIds = selectedFiles.join(',');
                const shareLink = `${window.location.origin}${window.location.pathname}?share=${shareIds}`;
                
                navigator.clipboard.writeText(shareLink).then(() => {
                     alert('Link zum Teilen wurde in die Zwischenablage kopiert!');
                }).catch(err => {
                    console.error('Fehler beim Kopieren: ', err);
                    alert('Kopieren fehlgeschlagen. Bitte manuell kopieren.');
                });
            };

            const toggleFileSelection = (fileId) => {
                setSelectedFiles(prev => 
                    prev.includes(fileId) ? prev.filter(id => id !== fileId) : [...prev, fileId]
                );
            };

            return (
                <div className="glass-pane p-6 rounded-2xl">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h2 className="text-2xl font-bold text-shadow mb-4 sm:mb-0">Dateien & Links</h2>
                        {isEditable && (
                            <div className="flex gap-2">
                                <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                    <Icon name="uploadCloud" className="w-5 h-5" /> Dateien hochladen
                                </button>
                                <button onClick={() => setShowAddLinkModal(true)} className="flex items-center gap-2 bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                    <Icon name="link" className="w-5 h-5" /> Link hinzuf√ºgen
                                </button>
                                <input type="file" multiple ref={fileInputRef} onChange={handleFileSelect} className="hidden" accept={compatibleFileTypes} />
                            </div>
                        )}
                    </div>
                    
                    {selectedFiles.length > 0 && isEditable && (
                         <div className="mb-4">
                            <button onClick={handleShareSelected} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                {selectedFiles.length} Element(e) teilen
                            </button>
                        </div>
                    )}

                    <div className="space-y-3">
                        {project.files.map(file => (
                            <div key={file.id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                <div className="flex items-center gap-4">
                                    {isEditable && <input type="checkbox" checked={selectedFiles.includes(file.id)} onChange={() => toggleFileSelection(file.id)} className="form-checkbox h-5 w-5 bg-transparent border-white/30 rounded text-blue-500 focus:ring-blue-500"/>}
                                    <Icon name={getFileIcon(file.type === 'link' ? 'link' : file.fileType)} className="w-6 h-6 text-gray-300" />
                                    <div>
                                        <p className="font-semibold text-shadow">{file.name}</p>
                                        {file.type === 'file' ? (
                                            <p className="text-xs text-gray-400">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                        ) : (
                                             <SecureLink 
                                                href={file.url} 
                                                target="_blank" 
                                                rel="noopener noreferrer" 
                                                className="text-xs text-blue-400 hover:underline"
                                            >
                                                {file.url}
                                            </SecureLink>
                                        )}
                                    </div>
                                </div>
                                <button className="text-gray-400 hover:text-white"><Icon name="moreVertical" className="w-5 h-5" /></button>
                            </div>
                        ))}
                        {project.files.length === 0 && <p className="text-center text-gray-400 py-8">Noch keine Dateien oder Links in diesem Projekt.</p>}
                    </div>
                    
                    {showAddLinkModal && <AddLinkModal onAdd={handleAddLink} onClose={() => setShowAddLinkModal(false)} />}
                </div>
            );
        };

        const AddLinkModal = ({ onAdd, onClose }) => {
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [urlError, setUrlError] = useState('');

            const handleUrlChange = (e) => {
                const newUrl = e.target.value;
                setUrl(newUrl);
                
                // Real-time URL-Validierung
                if (newUrl.trim()) {
                    try {
                        if (window.multiCharacterSanitizer) {
                            window.multiCharacterSanitizer.validateUrl(newUrl.trim(), {
                                requireHttps: false,
                                maxLength: 2048,
                                allowRelative: false
                            });
                        } else {
                            // Fallback-Validierung
                            new URL(newUrl.trim());
                        }
                        setUrlError('');
                    } catch (error) {
                        setUrlError(error.message || 'Ung√ºltige URL');
                    }
                } else {
                    setUrlError('');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!title.trim()) {
                    alert('Titel ist erforderlich');
                    return;
                }
                
                if (!url.trim()) {
                    alert('URL ist erforderlich');
                    return;
                }
                
                // Finale URL-Validierung vor dem Hinzuf√ºgen
                try {
                    const sanitizedTitle = window.multiCharacterSanitizer ? 
                        window.multiCharacterSanitizer.sanitize(title.trim(), { 
                            maxLength: 200, 
                            allowHtml: false 
                        }) : 
                        title.trim();
                    
                    const validatedUrl = window.multiCharacterSanitizer ? 
                        window.multiCharacterSanitizer.validateUrl(url.trim(), {
                            requireHttps: false,
                            maxLength: 2048,
                            allowRelative: false
                        }) : 
                        new URL(url.trim()).toString();
                    
                    onAdd(sanitizedTitle, validatedUrl);
                } catch (error) {
                    alert(`Fehler beim Hinzuf√ºgen des Links: ${error.message}`);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="glass-pane rounded-2xl w-full max-w-md text-white" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <h3 className="text-lg font-bold mb-4 text-shadow">Link hinzuf√ºgen</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <input 
                                        type="text" 
                                        value={title} 
                                        onChange={e => setTitle(e.target.value)} 
                                        placeholder="Titel" 
                                        maxLength={200}
                                        className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" 
                                        required 
                                    />
                                </div>
                                <div>
                                    <input 
                                        type="url" 
                                        value={url} 
                                        onChange={handleUrlChange} 
                                        placeholder="https://..." 
                                        maxLength={2048}
                                        className={`w-full p-2 rounded-lg bg-white/10 border text-white placeholder-gray-400 ${
                                            urlError ? 'border-red-500' : 'border-white/20'
                                        }`}
                                        required 
                                    />
                                    {urlError && (
                                        <p className="text-red-400 text-xs mt-1">{urlError}</p>
                                    )}
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg text-sm">
                                        Abbrechen
                                    </button>
                                    <button 
                                        type="submit" 
                                        disabled={!!urlError || !title.trim() || !url.trim()}
                                        className="bg-blue-500 px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Hinzuf√ºgen
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- AnalyticsPage Component ---
        const AnalyticsPage = () => {
            const [dashboard, setDashboard] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            useEffect(() => {
                const dashboardData = mockDashboards[0];
                const populatedWidgets = dashboardData.widgets.map(widget => ({ ...widget, integration: mockIntegrations[widget.integrationId] }));
                setDashboard({ ...dashboardData, widgets: populatedWidgets });
            }, []);
            if (!dashboard) return <PageWrapper><div>Lade...</div></PageWrapper>;
            const KpiWidget = ({ widget }) => {
                const value = Math.floor(Math.random() * 50000) + 1000;
                const change = (Math.random() * 10 - 5).toFixed(1);
                return (<div className="glass-pane p-4 flex flex-col h-full rounded-2xl"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><img src={platformLogos[widget.integration.platform]} onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} className="w-5 h-5 object-contain rounded-md" /><span className="text-sm font-medium text-gray-300 text-shadow">{kpiLabels[widget.kpi]}</span></div><button className="text-gray-400"><Icon name="moreVertical" className="w-4 h-4" /></button></div><div className="flex-grow flex flex-col justify-center"><p className="text-3xl lg:text-4xl font-bold text-shadow">{value.toLocaleString('de-DE')}</p><div className={`text-sm font-semibold flex items-center ${change >= 0 ? 'text-green-400' : 'text-red-400'}`}>{change >= 0 ? '‚ñ≤' : '‚ñº'} {change}%</div></div><div className="text-xs text-gray-400 mt-2 flex items-center gap-1"><Icon name="clock" className="w-3 h-3" /><span>{widget.timeFrame.replace(/_/g, ' ')}</span></div></div>);
            };
            const IntegrationsModal = ({ onClose }) => {
                const [integrations, setIntegrations] = useState({ available: [], connected: [] });
                useEffect(() => { setIntegrations({ available: availablePlatforms, connected: Object.values(mockIntegrations) }); }, []);
                return (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}><div className="glass-pane rounded-2xl w-full max-w-2xl text-white" onClick={e => e.stopPropagation()}><div className="p-6 border-b border-white/20"><h2 className="text-xl font-bold text-shadow">Integrationen verwalten</h2></div><div className="p-6 max-h-[80vh] overflow-y-auto"><h3 className="font-semibold mb-3 text-shadow">Verbundene Konten</h3><div className="space-y-3 mb-8">{integrations.connected.map(int => (<div key={int.id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg"><div className="flex items-center gap-3"><img src={platformLogos[int.platform]} onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} className="w-6 h-6 object-contain rounded" /><div><p className="font-semibold text-shadow">{int.platform}</p><p className="text-sm text-gray-300">{int.accountName}</p></div></div><div className="flex items-center gap-3">{int.status === 'connected' ? <Icon name="checkCircle" className="w-5 h-5 text-green-400" /> : <Icon name="xCircle" className="w-5 h-5 text-red-400" />}<button><Icon name="trash2" className="w-4 h-4 text-gray-400 hover:text-red-400" /></button></div></div>))}</div><h3 className="font-semibold mb-3 text-shadow">Neue Integration hinzuf√ºgen</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-3">{integrations.available.map(p => (<button key={p.id} className="flex items-center gap-3 p-3 border border-white/20 rounded-lg hover:bg-white/10"><img src={platformLogos[p.name]} onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} className="w-6 h-6 object-contain rounded" /><span className="font-semibold text-shadow">Mit {p.name} verbinden</span></button>))}</div></div></div></div>);
            };
            return (
                <PageWrapper>
                    {isModalOpen && <IntegrationsModal onClose={() => setIsModalOpen(false)} />}
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                        <div className="flex items-center gap-4 mb-4 sm:mb-0">{dashboard.logoUrl && <img src={dashboard.logoUrl} className="h-10 rounded-md" />}<h1 className="text-2xl sm:text-3xl font-bold text-shadow">{dashboard.name}</h1></div>
                        <div className="flex items-center space-x-2"><button onClick={() => setIsModalOpen(true)} className="glass-pane flex items-center px-4 py-2 rounded-lg shadow-sm text-sm"><Icon name="link" className="w-4 h-4 mr-2" /> Integrationen</button><button className="bg-blue-500 text-white flex items-center px-4 py-2 rounded-lg shadow-sm text-sm"><Icon name="plus" className="w-4 h-4 mr-2" /> KPI hinzuf√ºgen</button></div>
                    </header>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-12 gap-6">
                        {dashboard.widgets.map(widget => (<div key={widget.id} className="cursor-grab sm:col-span-1 md:col-span-1 lg:col-span-4"><KpiWidget widget={widget} /></div>))}
                        <div className="sm:col-span-1 md:col-span-1 lg:col-span-4 cursor-pointer border-2 border-dashed border-white/30 rounded-2xl flex items-center justify-center min-h-[150px]"><div className="text-center text-gray-300"><Icon name="plus" className="w-8 h-8 mx-auto mb-2" /><p className="font-semibold">KPI hinzuf√ºgen</p></div></div>
                    </div>
                </PageWrapper>
            );
        };

        // --- LibraryPage Component ---
        const LibraryPage = () => {
            const [templates, setTemplates] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeCategory, setActiveCategory] = useState('Alle');
            useEffect(() => { setTemplates(mockCmsData.data); }, []);
            const categories = useMemo(() => ['Alle', ...new Set(templates.map(t => t.category))], [templates]);
            const filteredTemplates = useMemo(() => templates.filter(template => (activeCategory === 'Alle' || template.category === activeCategory) && (searchTerm === '' || template.title.toLowerCase().includes(searchTerm.toLowerCase()))), [templates, searchTerm, activeCategory]);
            const DownloadButton = ({ url, format }) => (<a href={url} className="inline-flex items-center bg-white/10 text-xs font-bold px-3 py-1 rounded-full hover:bg-white/20"><Icon name={format === 'pdf' ? 'fileText' : 'file'} className="w-4 h-4 mr-2" />{format.toUpperCase()}</a>);
            return (
                <PageWrapper>
                    <header className="mb-8"><h1 className="text-3xl sm:text-4xl font-bold text-shadow">Smart Library</h1><p className="text-lg text-gray-300 mt-2 text-shadow">Vorlagen, Vertr√§ge und Best Practices.</p></header>
                    <div className="flex flex-col md:flex-row gap-4 mb-8">
                        <div className="relative flex-grow"><Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" /><input type="text" placeholder="Suchen..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-white/20 rounded-lg bg-white/10 text-white placeholder-gray-400" /></div>
                        <div className="flex-shrink-0 bg-black/20 p-1 rounded-lg border border-white/20 overflow-x-auto"><div className="flex">{categories.map(cat => (<button key={cat} onClick={() => setActiveCategory(cat)} className={`px-4 py-1 text-sm font-medium rounded-md whitespace-nowrap ${activeCategory === cat ? 'bg-blue-500 text-white' : 'text-gray-300 hover:text-white'}`}>{cat}</button>))}</div></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{filteredTemplates.map(template => (<div key={template.id} className="glass-pane p-6 rounded-2xl flex flex-col"><h3 className="text-lg font-bold text-shadow">{template.title}</h3><p className="text-sm text-gray-300 mt-2 flex-grow text-shadow">{template.description}</p><div className="border-t border-white/20 mt-4 pt-4 flex justify-between items-center"><span className="text-sm font-semibold text-gray-400">{template.category}</span><div className="flex gap-2">{template.files.docx && <DownloadButton url={template.files.docx} format="docx" />}{template.files.pdf && <DownloadButton url={template.files.pdf} format="pdf" />}</div></div></div>))}</div>
                </PageWrapper>
            );
        };
        
        // --- SupportPage Component ---
        const SupportPage = () => {
            const [activeTab, setActiveTab] = useState('assistant');
            const KnowledgeBaseView = () => {
                const [articles, setArticles] = useState([]);
                useEffect(() => { setArticles(mockKnowledgeBase.data); }, []);
                return (<div className="space-y-4">{articles.map(article => (<div key={article.id} className="glass-pane p-4 rounded-2xl"><h3 className="font-bold text-shadow">{article.title}</h3><p className="text-sm text-gray-300 mt-1">{article.category}</p></div>))}</div>);
            };
            const AssistantView = () => {
                const [chatHistory, setChatHistory] = useState([{ role: 'assistant', text: 'Hallo! Ich bin dein KI-Assistent f√ºr das Musikbusiness. Frag mich alles zu Ver√∂ffentlichungen, Marketing oder Branchen-Insights.' }]);
                const [inputValue, setInputValue] = useState('');
                const [isLoading, setIsLoading] = useState(false);
                const chatEndRef = useRef(null);

                useEffect(() => {
                    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, [chatHistory]);

                const handleSendMessage = async (e) => {
                    e.preventDefault();
                    if (!inputValue.trim() || isLoading) return;

                    const userMessage = { role: 'user', text: inputValue };
                    setChatHistory(prev => [...prev, userMessage]);
                    setInputValue('');
                    setIsLoading(true);

                    try {
                        // Pr√ºfe ob Backend verf√ºgbar ist
                        const apiConfig = window.apiConfig;
                        
                        if (!apiConfig || !apiConfig.hasBackend) {
                            // Demo-Modus: Simuliere KI-Antwort
                            setTimeout(() => {
                                const demoResponses = [
                                    "Im Demo-Modus kann ich grundlegende Fragen beantworten. F√ºr echte KI-Unterst√ºtzung ben√∂tigen Sie eine Backend-Verbindung.",
                                    "Das ist eine interessante Frage! Im Vollmodus w√ºrde ich Ihnen detaillierte Musikbusiness-Strategien vorschlagen.",
                                    "F√ºr Musikmarketing empfehle ich: 1) Zielgruppe definieren, 2) Social Media nutzen, 3) Collaborations eingehen. (Demo-Antwort)",
                                    "Streaming-Plattformen sind wichtig f√ºr die Reichweite. Spotify, Apple Music und YouTube Music sollten Priorit√§t haben. (Demo-Modus)"
                                ];
                                
                                const randomResponse = demoResponses[Math.floor(Math.random() * demoResponses.length)];
                                setChatHistory(prev => [...prev, { 
                                    role: 'assistant', 
                                    text: `${randomResponse}\n\nüí° Hinweis: Dies ist eine Demo-Antwort. Starten Sie das Backend f√ºr echte KI-Unterst√ºtzung.`
                                }]);
                                setIsLoading(false);
                            }, 1500); // Simuliere Verarbeitungszeit
                            return;
                        }

                        // DoS-Schutz: Verwende sichere API-Request mit Queue
                        const result = await apiQueue.add(async () => {
                            return await apiRetry(async () => {
                                const response = await safeApiRequest(`${apiConfig.baseUrl}/api/gemini/chat`, {
                                    method: 'POST',
                                    headers: { 
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json'
                                    },
                                    body: JSON.stringify({ message: userMessage.text })
                                }, 30000); // 30s Timeout f√ºr AI-Requests

                                return await response.json();
                            }, 3, 2000); // 3 Versuche, 2s base delay
                        });

                        const botResponseText = result.response || "Entschuldigung, ich konnte keine Antwort generieren.";
                        setChatHistory(prev => [...prev, { role: 'assistant', text: botResponseText }]);

                    } catch (error) {
                        console.error("Error with Backend API:", error);
                        
                        let errorMessage = 'Entschuldigung, es gab ein Problem. Bitte versuche es sp√§ter erneut.';
                        
                        if (error.message.includes('Backend-Verbindung')) {
                            errorMessage = 'Keine Verbindung zum Server. Die Anwendung l√§uft im Demo-Modus.';
                        } else if (error.message.includes('429')) {
                            errorMessage = 'Zu viele Anfragen. Bitte warten Sie einen Moment und versuchen es erneut.';
                        } else if (error.message.includes('timeout')) {
                            errorMessage = 'Anfrage-Timeout. Der Server braucht zu lange zum Antworten.';
                        } else if (error.message.includes('Request timeout')) {
                            errorMessage = 'Verbindungs-Timeout. Bitte pr√ºfen Sie Ihre Internetverbindung.';
                        }
                        
                        setChatHistory(prev => [...prev, { role: 'assistant', text: errorMessage }]);
                    } finally {
                        setIsLoading(false);
                    }
                };

                return (
                    <div className="flex flex-col h-[70vh] glass-pane rounded-2xl">
                        <div className="flex-grow p-6 overflow-y-auto">
                            <div className="space-y-4">
                                {chatHistory.map((msg, index) => (
                                    <div key={index} className={`flex items-start gap-3 ${msg.role === 'user' ? 'justify-end' : ''}`}>
                                        {msg.role === 'assistant' && <div className="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0"></div>}
                                        <div className={`max-w-full sm:max-w-xl p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-white/10 text-gray-200'}`}>
                                            <p className="text-sm whitespace-pre-wrap text-shadow">{msg.text}</p>
                                        </div>
                                    </div>
                                ))}
                                {isLoading && (
                                    <div className="flex items-start gap-3">
                                        <div className="w-8 h-8 rounded-full bg-blue-500"></div>
                                        <div className="max-w-md p-3 rounded-lg bg-white/10 flex items-center space-x-1">
                                            <div className="w-2 h-2 bg-gray-300 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                                            <div className="w-2 h-2 bg-gray-300 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                                            <div className="w-2 h-2 bg-gray-300 rounded-full animate-pulse"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef} />
                            </div>
                        </div>
                        <form onSubmit={handleSendMessage} className="p-4 border-t border-white/20 flex items-center gap-3">
                            <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Stelle eine Frage..." className="w-full px-4 py-2 border border-white/20 rounded-full bg-white/10 text-white placeholder-gray-400" disabled={isLoading} />
                            <button type="submit" className="bg-blue-500 text-white p-3 rounded-full disabled:bg-blue-400/50" disabled={isLoading}>
                                <Icon name="send" className="w-5 h-5" />
                            </button>
                        </form>
                    </div>
                );
            };

            return (
                <PageWrapper>
                    <header className="text-center mb-8"><h1 className="text-3xl sm:text-4xl font-bold text-shadow">Support Hub</h1><p className="text-lg text-gray-300 mt-2 text-shadow">Finde Antworten oder frage unseren KI-Assistenten.</p></header>
                    <div className="flex justify-center mb-6"><div className="glass-pane p-1 rounded-full flex"><button onClick={() => setActiveTab('kb')} className={`px-4 py-2 text-sm font-medium rounded-full ${activeTab === 'kb' ? 'bg-white/20' : ''}`}>Wissensdatenbank</button><button onClick={() => setActiveTab('assistant')} className={`px-4 py-2 text-sm font-medium rounded-full ${activeTab === 'assistant' ? 'bg-white/20' : ''}`}>KI-Assistent</button></div></div>
                    {activeTab === 'kb' ? <KnowledgeBaseView /> : <AssistantView />}
                </PageWrapper>
            );
        };
        
        // --- LearningCenter Component (formerly TeamStartPage) ---
        const LearningCenter = () => {
            const [paths, setPaths] = useState([]);
            const [selectedPath, setSelectedPath] = useState(null);
            useEffect(() => { setPaths(mockLearningPaths); }, []);
            const LearningPathDetail = ({ path, onBack }) => {
                const [completedModules, setCompletedModules] = useState(['m1-1']);
                const [activeModule, setActiveModule] = useState(path.modules[0]);
                const handleCompleteModule = (moduleId) => { if (!completedModules.includes(moduleId)) { setCompletedModules(prev => [...prev, moduleId]); const currentIndex = path.modules.findIndex(m => m.id === moduleId); if (currentIndex + 1 < path.modules.length) { setActiveModule(path.modules[currentIndex + 1]); } } };
                const progress = (completedModules.length / path.modules.length) * 100;
                const moduleIcons = { video: "playCircle", text: "fileText", quiz: "helpCircle" };
                const QuizModule = ({ module, onComplete }) => {
                    const [selectedAnswer, setSelectedAnswer] = useState(null);
                    return (<div className="p-6"><h3 className="font-bold text-lg mb-4 text-shadow">{module.content.question}</h3><div className="space-y-3 mb-4">{module.content.options.map((option, index) => (<button key={index} onClick={() => setSelectedAnswer(index)} className={`w-full text-left p-3 border border-white/20 rounded-lg ${selectedAnswer === index ? 'bg-blue-400/50' : 'bg-white/10'}`}>{option}</button>))}</div><button onClick={() => { if(selectedAnswer === module.content.correctAnswerIndex) onComplete(module.id) }} className="w-full p-2 bg-blue-500 text-white rounded-lg">Antwort pr√ºfen</button></div>);
                };
                return (<div><button onClick={onBack} className="flex items-center gap-2 text-sm mb-4 text-gray-300 hover:text-white">
                    <Icon name="arrowLeft" className="w-4 h-4" /> Zur√ºck
                </button>
                <h2 className="text-2xl font-bold text-shadow">{path.title}</h2>
                <div className="my-6">
                    <div className="w-full bg-white/20 rounded-full h-2.5">
                        <div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                    </div>
                </div>
                <div className="flex flex-col lg:flex-row gap-8">
                    <div className="w-full lg:w-1/3">
                        <h3 className="font-bold mb-3 text-shadow">Module</h3>
                        <div className="space-y-2">
                            {path.modules.map(module => (
                                <button key={module.id} onClick={() => setActiveModule(module)} className={`w-full text-left p-3 rounded-lg flex items-center gap-3 ${activeModule.id === module.id ? 'bg-white/20' : 'hover:bg-white/10'}`}>
                                    {completedModules.includes(module.id) ? <Icon name="checkCircle" className="w-5 h-5 text-green-400" /> : <Icon name="circle" className="w-5 h-5 text-gray-400" />}
                                    <Icon name={moduleIcons[module.type]} className="w-5 h-5" />
                                    <span>{module.title}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="w-full lg:w-2/3 glass-pane rounded-2xl">
                        {activeModule.type === 'quiz' ? <QuizModule module={activeModule} onComplete={handleCompleteModule} /> : <div className="p-6">{activeModule.content || `Inhalt f√ºr ${activeModule.title}`}<button onClick={() => handleCompleteModule(activeModule.id)} className="mt-4 p-2 bg-blue-500 text-white rounded">Als erledigt markieren</button></div>}
                    </div>
                </div>
            </div>);
            };
            if (selectedPath) return <PageWrapper><LearningPathDetail path={selectedPath} onBack={() => setSelectedPath(null)} /></PageWrapper>;
            return (<PageWrapper><header className="text-center mb-8"><h1 className="text-3xl sm:text-4xl font-bold text-shadow">Learning Center</h1><p className="text-lg text-gray-300 mt-2 text-shadow">W√§hle deinen Lernpfad.</p></header><div className="space-y-4">{paths.map(path => (<button key={path.id} onClick={() => setSelectedPath(path)} className="w-full text-left p-6 glass-pane rounded-2xl shadow-md hover:bg-white/20 transition"><span className="bg-blue-500/50 text-blue-100 text-xs font-semibold px-2.5 py-0.5 rounded-full mb-2 inline-block">{path.targetRole}</span><h3 className="text-xl font-bold text-shadow">{path.title}</h3><p className="text-gray-300 mt-1 text-shadow">{path.description}</p></button>))}</div></PageWrapper>);
        };
        
        // --- ComplyCheckPage Component ---
        const ComplyCheckPage = ({ onTestComplete }) => {
            const [activeTool, setActiveTool] = useState(null);
            const DsgvoSelfTest = () => {
                const [answers, setAnswers] = useState({});
                const [isFinished, setIsFinished] = useState(false);
                const handleAnswer = (qId, answer) => setAnswers(prev => ({ ...prev, [qId]: answer }));
                const score = Object.values(answers).filter(Boolean).length;

                const handleFinish = () => {
                    setIsFinished(true);
                    onTestComplete(`${score} / ${dsgvoQuestions.length}`);
                };

                return (<div className="glass-pane p-6 rounded-2xl"><h3 className="text-xl font-bold mb-4 text-shadow">DSGVO-Selbsttest</h3>{!isFinished ? (<div><div className="space-y-6">{dsgvoQuestions.map(q => (<div key={q.id}><p className="font-semibold mb-2 text-shadow">{q.text}</p><div className="flex gap-4"><button onClick={() => handleAnswer(q.id, true)} className={`flex items-center gap-2 p-2 rounded-lg border-2 ${answers[q.id] === true ? 'border-green-400 bg-green-500/20' : 'border-white/20'}`}><Icon name="check" className="w-5 h-5 text-green-400" /> Ja</button><button onClick={() => handleAnswer(q.id, false)} className={`flex items-center gap-2 p-2 rounded-lg border-2 ${answers[q.id] === false ? 'border-red-400 bg-red-500/20' : 'border-white/20'}`}><Icon name="x" className="w-5 h-5 text-red-400" /> Nein</button></div></div>))}</div><button onClick={handleFinish} disabled={Object.keys(answers).length !== dsgvoQuestions.length} className="mt-8 w-full p-3 bg-blue-500 text-white rounded-lg disabled:bg-gray-500">Auswertung</button></div>) : (<div className="text-center"><h4 className="text-lg font-bold text-shadow">Ergebnis</h4><p className="text-5xl font-bold my-4 text-shadow">{score} / {dsgvoQuestions.length}</p><button onClick={() => { setIsFinished(false); setAnswers({}); }} className="mt-6 text-blue-400">Wiederholen</button></div>)}</div>);
            };
            const AvvGenerator = () => {
                const [generated, setGenerated] = useState(false);
                return (<div className="glass-pane p-6 rounded-2xl"><h3 className="text-xl font-bold mb-4 text-shadow">AV-Vertrag-Generator</h3>{!generated ? (<form onSubmit={(e) => { e.preventDefault(); setGenerated(true); }} className="space-y-4"><div><label className="block text-sm text-shadow">Name des Dienstleisters</label><input type="text" required className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" /></div><div><label className="block text-sm text-shadow">Zweck der Verarbeitung</label><input type="text" required className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" /></div><button type="submit" className="w-full p-3 bg-blue-500 text-white rounded-lg">Generieren</button></form>) : (<div><h4 className="font-bold mb-2 text-shadow">Generierte Vorlage</h4><pre className="p-4 bg-black/20 rounded-md text-xs overflow-x-auto">... Vertragstext ...</pre><button onClick={() => setGenerated(false)} className="mt-4 w-full p-2 border border-white/20 rounded-lg">Neue Vorlage</button></div>)}</div>);
            };
            if (activeTool) return <PageWrapper><button onClick={() => setActiveTool(null)} className="mb-4 flex items-center gap-1 text-gray-300 hover:text-white"><Icon name="arrowLeft" className="w-4 h-4" /> Zur√ºck</button>{activeTool === 'dsgvo' ? <DsgvoSelfTest /> : <AvvGenerator />}</PageWrapper>;
            return (<PageWrapper><header className="text-center mb-8"><h1 className="text-3xl sm:text-4xl font-bold text-shadow">ComplyCheck</h1><p className="text-lg text-gray-300 mt-2 text-shadow">Tools f√ºr deine DSGVO-Compliance.</p></header><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><button onClick={() => setActiveTool('dsgvo')} className="glass-pane p-8 text-left rounded-2xl shadow-md hover:bg-white/20 transition"><Icon name="shieldCheck" className="w-10 h-10 text-blue-300 mb-4" /><h2 className="text-xl font-bold text-shadow">DSGVO-Selbsttest</h2></button><button onClick={() => setActiveTool('avv')} className="glass-pane p-8 text-left rounded-2xl shadow-md hover:bg-white/20 transition"><Icon name="fileText" className="w-10 h-10 text-green-300 mb-4" /><h2 className="text-xl font-bold text-shadow">AV-Vertrag-Generator</h2></button></div></PageWrapper>);
        };

        // --- ProfilePage Component ---
        const ProfilePage = ({setActivePage}) => {
            const { user } = useAuth();
            const [displayName, setDisplayName] = useState(user?.displayName || '');
            const [newPassword, setNewPassword] = useState('');
            const [message, setMessage] = useState('');

            const handleProfileUpdate = async (e) => {
                e.preventDefault();
                try {
                    await window.firebase.updateProfile(window.firebase.auth.currentUser, { displayName });
                    setMessage('Profil erfolgreich aktualisiert!');
                } catch (error) {
                    setMessage(`Fehler: ${error.message}`);
                }
            };

            const handlePasswordChange = async (e) => {
                e.preventDefault();
                try {
                    // Pr√ºfe ob im Demo-Modus
                    if (window.apiConfig && window.apiConfig.demoMode) {
                        setMessage('Passwort-√Ñnderung im Demo-Modus nicht verf√ºgbar. Starten Sie das Backend f√ºr volle Funktionalit√§t.');
                        return;
                    }
                    
                    await window.firebase.updatePassword(window.firebase.auth.currentUser, newPassword);
                    setMessage('Passwort erfolgreich ge√§ndert!');
                    setNewPassword('');
                } catch (error) {
                    setMessage(`Fehler: ${error.message}`);
                }
            };
            
            return (
                <PageWrapper>
                    <h1 className="text-3xl sm:text-4xl font-bold mb-8 text-shadow">Dein Profil</h1>
                    {message && <p className="mb-4 p-3 glass-pane rounded-lg text-center text-shadow">{message}</p>}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="glass-pane p-6 rounded-2xl">
                            <h2 className="text-2xl font-bold mb-4 text-shadow">Profilinformationen</h2>
                            <form onSubmit={handleProfileUpdate} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Anzeigename</label>
                                    <input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">E-Mail</label>
                                    <p className="mt-1 text-shadow">{user?.email}</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Profilbild</label>
                                    <div className="flex items-center gap-4 mt-2">
                                        <img src={user?.photoURL || `https://placehold.co/100x100/EBF4FF/1a1a1a?text=${user?.displayName?.charAt(0) || 'U'}`} className="w-16 h-16 rounded-full" />
                                        <input type="file" className="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500/50 file:text-blue-100 hover:file:bg-blue-500/80 cursor-pointer" disabled title="Funktion noch nicht implementiert" />
                                    </div>
                                </div>
                                <button type="submit" className="w-full p-2 bg-blue-500 text-white rounded-lg font-bold">Speichern</button>
                            </form>
                        </div>
                        <div className="glass-pane p-6 rounded-2xl">
                            <h2 className="text-2xl font-bold mb-4 text-shadow">Passwort √§ndern</h2>
                            <form onSubmit={handlePasswordChange} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Neues Passwort</label>
                                    <input type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} className="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400" />
                                </div>
                                <button type="submit" className="w-full p-2 bg-blue-500 text-white rounded-lg font-bold">Passwort √§ndern</button>
                            </form>
                        </div>
                    </div>
                </PageWrapper>
            );
        };
        
        // --- APP COMPONENT ---
        
        // Final App Component mit Error-Boundaries
        const App = () => {
            const [activeAuthPage, setActiveAuthPage] = useState('landing');
            const [appInitialized, setAppInitialized] = useState(false);

            useEffect(() => {
                // App-Initialisierung mit Timeout
                const initTimer = setTimeout(() => {
                    console.log('‚úÖ App initialization complete');
                    setAppInitialized(true);
                }, 1000);

                return () => clearTimeout(initTimer);
            }, []);

            // Loading Screen
            if (!appInitialized) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900">
                        <div className="glass-pane p-8 rounded-2xl text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                            <p className="text-white text-lg font-semibold">Musik-Plattform wird geladen...</p>
                        </div>
                    </div>
                );
            }

            return (
                <ErrorBoundary>
                    <AuthProvider>
                        <AppContent 
                            activeAuthPage={activeAuthPage} 
                            setActiveAuthPage={setActiveAuthPage} 
                        />
                    </AuthProvider>
                </ErrorBoundary>
            );
        };

        // App Content Handler
        const AppContent = ({ activeAuthPage, setActiveAuthPage }) => {
            const { user } = useAuth();

            const handleLogin = (userData) => {
                console.log('‚úÖ User logged in:', userData);
                setActiveAuthPage('app');
            };

            const handleRegister = (userData) => {
                console.log('‚úÖ User registered:', userData);
                setActiveAuthPage('app');
            };

            // Bestimme welche Seite angezeigt werden soll
            if (user || activeAuthPage === 'app') {
                return <MainApp />;
            }

            switch (activeAuthPage) {
                case 'login':
                    return <LoginPage onLogin={handleLogin} setActiveAuthPage={setActiveAuthPage} />;
                case 'register':
                    return <RegisterPage onRegister={handleRegister} setActiveAuthPage={setActiveAuthPage} />;
                default:
                    return <LandingPage setActiveAuthPage={setActiveAuthPage} />;
            }
        };

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        
        // Sichere App-Renderung mit Fallback
        try {
            root.render(<App />);
            console.log('üöÄ App successfully rendered');
        } catch (error) {
            console.error('üö® Critical render error:', error);
            
            // Emergency Fallback
            document.getElementById('root').innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #7c3aed 100%); color: white; font-family: system-ui;">
                    <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; text-align: center; max-width: 400px;">
                        <h1>üö® Kritischer Fehler</h1>
                        <p>Die Anwendung konnte nicht geladen werden.</p>
                        <div style="margin-top: 1rem;">
                            <a href="demo.html" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none; margin-right: 0.5rem;">Demo √∂ffnen</a>
                            <a href="emergency.html" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none;">Notfallmodus</a>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
